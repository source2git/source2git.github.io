<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta name="theme-color" content="#0080CA">
  
  <title>Chrome扩展开发101 | s0urceLab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="扩展开发入门">
<meta name="keywords" content="FrontEnd">
<meta property="og:type" content="article">
<meta property="og:title" content="Chrome扩展开发101">
<meta property="og:url" content="http://s0urcelab.github.io/2020/06/02/js-chrome-extensions-101/index.html">
<meta property="og:site_name" content="s0urceLab">
<meta property="og:description" content="扩展开发入门">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://i.loli.net/2020/07/03/Y4kgrnwbN2Jo5fa.png">
<meta property="og:image" content="https://i.loli.net/2020/07/03/wu4MDmAyf6FUJ2h.png">
<meta property="og:image" content="https://i.loli.net/2020/07/03/Oam3quwABITzlV1.png">
<meta property="og:image" content="https://i.loli.net/2020/07/03/dQNu6c7D31XG4sp.png">
<meta property="og:image" content="https://i.loli.net/2020/07/03/agkr8jyqbevf6Mw.png">
<meta property="og:image" content="https://i.loli.net/2020/07/03/BsRdVgHlhZbLFrC.png">
<meta property="og:image" content="https://i.loli.net/2020/07/03/vYiFtLob5JuTy67.png">
<meta property="og:image" content="https://i.loli.net/2020/07/03/8IZfyszvUK2a5rH.png">
<meta property="og:image" content="https://i.loli.net/2020/07/03/cUQrwbqu6GPaM8n.png">
<meta property="og:image" content="https://i.loli.net/2020/07/03/jPEivBIhAnU7umM.png">
<meta property="og:image" content="https://i.loli.net/2020/07/03/DwF3NG7jyJLO2UT.png">
<meta property="og:image" content="https://i.loli.net/2020/07/03/fahnOCMuXws1ocQ.png">
<meta property="og:image" content="https://i.loli.net/2020/07/03/l8UvIGgJYLfROui.png">
<meta property="og:updated_time" content="2021-03-02T18:37:01.597Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chrome扩展开发101">
<meta name="twitter:description" content="扩展开发入门">
<meta name="twitter:image" content="https://i.loli.net/2020/07/03/Y4kgrnwbN2Jo5fa.png">
  
  
    <link rel="icon" href="/favicon.ico">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div class="anime-container">
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
      <div class="anime-item"></div>
    
  </div>
  <div id="header-outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">s0urceLab</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/ppt">PPT</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://s0urcelab.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-js-chrome-extensions-101" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/02/js-chrome-extensions-101/" class="article-date">
  <time datetime="2020-06-02T16:00:00.000Z" itemprop="datePublished">2020-06-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Chrome扩展开发101
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>扩展开发入门<br><a id="more"></a></p>
<h2 id="扩展是什么"><a href="#扩展是什么" class="headerlink" title="扩展是什么"></a>扩展是什么</h2><blockquote>
<p>Extensions are small software programs. They are built on web technologies such as HTML, JavaScript, and CSS.</p>
</blockquote>
<p>根据官方文档的描述，chrome扩展是一种基于web技术的增强程序。当然也可以通过c++编写的dll实现一些更加复杂的功能。</p>
<h2 id="为什么需要扩展"><a href="#为什么需要扩展" class="headerlink" title="为什么需要扩展"></a>为什么需要扩展</h2><ul>
<li>浏览器级别的长生命周期，常驻后台监听各类数据</li>
<li>执行一些高权限敏感操作，例如注入JS，样式，不受跨域策略限制的发起网络请求</li>
<li>通过devtools提供的API实现React tools一类的开发者工具</li>
<li>拥有独立的弹窗或弹层已经消息通信机制，与用户进行各种交互，例如google自家的翻译、Gmail等</li>
<li>…</li>
</ul>
<h2 id="开发扩展的工具-amp-环境"><a href="#开发扩展的工具-amp-环境" class="headerlink" title="开发扩展的工具&amp;环境"></a>开发扩展的工具&amp;环境</h2><p><strong>NOTHING！</strong><br>只要你喜欢，记事本都行。</p>
<h2 id="Hello-Extensions"><a href="#Hello-Extensions" class="headerlink" title="Hello Extensions"></a>Hello Extensions</h2><p><strong>/Demo/manifest.json</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"Hello Extensions"</span>,</span><br><span class="line">    <span class="string">"description"</span> : <span class="string">"Base Level Extension"</span>,</span><br><span class="line">    <span class="string">"version"</span>: <span class="string">"1.0"</span>,</span><br><span class="line">    <span class="string">"manifest_version"</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>完整配置项可以参考官方文档。<br>根目录下只有manifest.json是必须的，其他HTML，JS都是可选的。</p>
<h2 id="扩展UI的组成部分"><a href="#扩展UI的组成部分" class="headerlink" title="扩展UI的组成部分"></a>扩展UI的组成部分</h2><h3 id="右上角图标（browserAction）"><a href="#右上角图标（browserAction）" class="headerlink" title="右上角图标（browserAction）"></a>右上角图标（browserAction）</h3><p>browserAction和pageAction是浏览器右上角区域的图标，包含Icon、角标和点击后的弹窗，pageAction顾名思义是特化的browserAction，只在特定情况下生效（点亮）：<br><img src="https://i.loli.net/2020/07/03/Y4kgrnwbN2Jo5fa.png" alt="browserAction"><br><img src="https://i.loli.net/2020/07/03/wu4MDmAyf6FUJ2h.png" alt="pageAction"></p>
<h3 id="弹窗（Popup）"><a href="#弹窗（Popup）" class="headerlink" title="弹窗（Popup）"></a>弹窗（Popup）</h3><p><img src="https://i.loli.net/2020/07/03/Oam3quwABITzlV1.png" alt></p>
<h3 id="提示（Tooltip）"><a href="#提示（Tooltip）" class="headerlink" title="提示（Tooltip）"></a>提示（Tooltip）</h3><p><img src="https://i.loli.net/2020/07/03/dQNu6c7D31XG4sp.png" alt></p>
<h3 id="地址栏关键词（Omnibox）"><a href="#地址栏关键词（Omnibox）" class="headerlink" title="地址栏关键词（Omnibox）"></a>地址栏关键词（Omnibox）</h3><p><img src="https://i.loli.net/2020/07/03/agkr8jyqbevf6Mw.png" alt></p>
<h3 id="右键菜单（Context-Menu）"><a href="#右键菜单（Context-Menu）" class="headerlink" title="右键菜单（Context Menu）"></a>右键菜单（Context Menu）</h3><p><img src="https://i.loli.net/2020/07/03/BsRdVgHlhZbLFrC.png" alt></p>
<h3 id="响应命令（Commands）"><a href="#响应命令（Commands）" class="headerlink" title="响应命令（Commands）"></a>响应命令（Commands）</h3><p>在background.js中监听某些预定义的按键组合，从而执行特定代码，也可以用来调起弹窗，没有GUI<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// manifest.json</span></span><br><span class="line"></span><br><span class="line"><span class="string">"commands"</span>: &#123;</span><br><span class="line">    <span class="string">"_execute_browser_action"</span>: &#123;</span><br><span class="line">      <span class="string">"suggested_key"</span>: &#123;</span><br><span class="line">        <span class="string">"default"</span>: <span class="string">"Ctrl+Shift+F"</span>,</span><br><span class="line">        <span class="string">"mac"</span>: <span class="string">"MacCtrl+Shift+F"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"description"</span>: <span class="string">"Opens hello.html"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="劫持页面（Override-Pages）"><a href="#劫持页面（Override-Pages）" class="headerlink" title="劫持页面（Override Pages）"></a>劫持页面（Override Pages）</h3><p>可替换chrome默认的特殊页面，例如历史记录，新标签页等，下图替换了新标签页：<br><img src="https://i.loli.net/2020/07/03/vYiFtLob5JuTy67.png" alt></p>
<h3 id="开发者面板（Devtools-Tab）"><a href="#开发者面板（Devtools-Tab）" class="headerlink" title="开发者面板（Devtools Tab）"></a>开发者面板（Devtools Tab）</h3><p>我们熟悉的React Devtools正是这种形式：<br><img src="https://i.loli.net/2020/07/03/8IZfyszvUK2a5rH.png" alt></p>
<h3 id="选项页（Options-Page）"><a href="#选项页（Options-Page）" class="headerlink" title="选项页（Options Page）"></a>选项页（Options Page）</h3><p>一种专门用来进行扩展配置的页面，新版Chrome允许非全屏配置页<br><img src="https://i.loli.net/2020/07/03/cUQrwbqu6GPaM8n.png" alt></p>
<p><img src="https://i.loli.net/2020/07/03/jPEivBIhAnU7umM.png" alt></p>
<h2 id="扩展脚本的类型"><a href="#扩展脚本的类型" class="headerlink" title="扩展脚本的类型"></a>扩展脚本的类型</h2><h3 id="后台脚本（Background-Script）"><a href="#后台脚本（Background-Script）" class="headerlink" title="后台脚本（Background Script）"></a>后台脚本（Background Script）</h3><blockquote>
<p>Extensions are event based programs used to modify or enhance the Chrome browsing experience.<br>Extensions monitor these events in their background script</p>
</blockquote>
<p>扩展是事件驱动的，后台脚本生命周期最长，从浏览器启动直到关闭都在后台监听。区别于内容页脚本，它无法访问DOM也没有上下文环境。（<a href="https://stackoverflow.com/questions/24978473/background-html-vs-background-js-chrome-extension" title="stackoverflow" target="_blank" rel="noopener">注</a>）这非常像Web Worker或者Electron中的主线程。</p>
<p>后台脚本的生命周期和事件处理流程可以参考官方文档 <a href="https://developer.chrome.com/extensions/background_pages" target="_blank" rel="noopener">Manage Events with Background Scripts</a></p>
<p>这里注意区分一个概念，在很多扩展开发教程或文档中，会提到background page，也就是扩展面板里的”背景页“：<br><img src="https://i.loli.net/2020/07/03/DwF3NG7jyJLO2UT.png" alt><br>看起来它似乎是后台脚本所对应的HTML页面，而且经过测试会发现，后台脚本确实可以访问这个”页面“的DOM。既然如此为什么上文又说它不能访问DOM也没有上下文环境呢？</p>
<p>我们回头看看后台脚本的配置方式：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式1：</span></span><br><span class="line"><span class="comment">// manifest.json</span></span><br><span class="line"><span class="string">"background"</span>: &#123;</span><br><span class="line">    <span class="string">"persistent"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"scripts"</span>: [ <span class="string">"background.js"</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式2：</span></span><br><span class="line"><span class="comment">// manifest.json</span></span><br><span class="line"><span class="string">"background"</span>: &#123;</span><br><span class="line">    <span class="string">"persistent"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"page"</span>: <span class="string">"background.html"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// background.html</span></span><br><span class="line">&lt;script src=<span class="string">"background.js"</span>&gt;&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>这两种后台脚本的加载方式其实是互斥的，也就是说背景页只是一个承载后台脚本的容器，方便调用Devtools审查元素、console等等面板协助开发，仅此而已。所以即便这个DOM环境存在，你也不应该使用它。</p>
<h3 id="内容页脚本（Content-scripts）"><a href="#内容页脚本（Content-scripts）" class="headerlink" title="内容页脚本（Content scripts）"></a>内容页脚本（Content scripts）</h3><blockquote>
<p>Content scripts are files that run in the context of web pages. By using the standard Document Object Model (DOM), they are able to read details of the web pages the browser visits, make changes to them and pass information to their parent extension.</p>
</blockquote>
<p>类似普通网页中的JS，内容页脚本运行在扩展页面的上下文环境中，能访问当前页面的DOM。类似的，它很像Electron的渲染线程，专职处理UI相关事务。</p>
<h4 id="注入脚本（Inject-Scripts）"><a href="#注入脚本（Inject-Scripts）" class="headerlink" title="注入脚本（Inject Scripts）"></a>注入脚本（Inject Scripts）</h4><p>注入脚本属于一种特殊的内容页脚本，可以通过某些方式注入到页面的上下文环境中。</p>
<h5 id="程序注入（Inject-Programmatically）"><a href="#程序注入（Inject-Programmatically）" class="headerlink" title="程序注入（Inject Programmatically）"></a>程序注入（Inject Programmatically）</h5><p>注入一段代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">chrome.runtime.onMessage.addListener(</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">message, callback</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (message == “changeColor”)&#123;</span><br><span class="line">        chrome.tabs.executeScript(&#123;</span><br><span class="line">          code: <span class="string">'document.body.style.backgroundColor="orange"'</span></span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure></p>
<p>注入一个js文件：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">chrome.runtime.onMessage.addListener(</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">message, callback</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (message == “runContentScript”)&#123;</span><br><span class="line">        chrome.tabs.executeScript(&#123;</span><br><span class="line">          file: <span class="string">'contentScript.js'</span></span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure></p>
<h5 id="声明注入（Inject-Declaratively）"><a href="#声明注入（Inject-Declaratively）" class="headerlink" title="声明注入（Inject Declaratively）"></a>声明注入（Inject Declaratively）</h5><p>在匹配命中的网页中注入代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// manifest.json</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">"name"</span>: <span class="string">"My extension"</span>,</span><br><span class="line"> ...</span><br><span class="line"> <span class="string">"content_scripts"</span>: [</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="string">"matches"</span>: [<span class="string">"http://*.domain.com/*"</span>],</span><br><span class="line">     <span class="string">"css"</span>: [<span class="string">"myStyles.css"</span>],</span><br><span class="line">     <span class="string">"js"</span>: [<span class="string">"contentScript.js"</span>]</span><br><span class="line">   &#125;</span><br><span class="line"> ],</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="逻辑图示"><a href="#逻辑图示" class="headerlink" title="逻辑图示"></a>逻辑图示</h3><p><img src="https://i.loli.net/2020/07/03/fahnOCMuXws1ocQ.png" alt></p>
<h2 id="扩展的通信-消息机制"><a href="#扩展的通信-消息机制" class="headerlink" title="扩展的通信/消息机制"></a>扩展的通信/消息机制</h2><p>由于扩展内经常同时存在多种上下文迥异的js，很多时候需要通过某种机制在这些js之间进行通信，chrome也提供了专门的API：</p>
<h3 id="单次消息（Simple-one-time-requests）"><a href="#单次消息（Simple-one-time-requests）" class="headerlink" title="单次消息（Simple one-time requests）"></a>单次消息（Simple one-time requests）</h3><p>当你只需要发送一些简单的消息，你可以使用<code>runtime.sendMessage</code>或者<code>tabs.sendMessage</code>发送一些JSON格式的消息：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chrome.runtime.sendMessage(&#123;<span class="attr">greeting</span>: <span class="string">"hello"</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(response.farewell);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>如果你需要定向的把消息发送到指定tab的内容页脚本，例如当前页：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chrome.tabs.query(&#123;<span class="attr">active</span>: <span class="literal">true</span>, <span class="attr">currentWindow</span>: <span class="literal">true</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">tabs</span>) </span>&#123;</span><br><span class="line">  chrome.tabs.sendMessage(tabs[<span class="number">0</span>].id, &#123;<span class="attr">greeting</span>: <span class="string">"hello"</span>&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(response.farewell);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>在接收端，<code>runtime.onMessage</code>上注册监听即可接收/回复消息：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">chrome.runtime.onMessage.addListener(</span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params">request, sender, sendResponse</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(sender.tab ?</span><br><span class="line">                <span class="string">"from a content script:"</span> + sender.tab.url :</span><br><span class="line">                <span class="string">"from the extension"</span>);</span><br><span class="line">    <span class="keyword">if</span> (request.greeting == <span class="string">"hello"</span>)</span><br><span class="line">      sendResponse(&#123;<span class="attr">farewell</span>: <span class="string">"goodbye"</span>&#125;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure></p>
<p>值得注意的是，如果你在多个内容页脚本中监听同一个消息，只有第一个调用<code>sendResponse</code>的地方能成功回复，之后的调用将会被忽略。</p>
<h3 id="长连接消息（Long-lived-connections）"><a href="#长连接消息（Long-lived-connections）" class="headerlink" title="长连接消息（Long-lived connections）"></a>长连接消息（Long-lived connections）</h3><p>上文中提到的单次消息类似HTTP的“请求/响应”模式，而长连接消息则类似socket，建立channel后双方都可以监听/发送消息，比较常见的一类场景是：扩展需要读取用户在某个页面上的输入，以此提供一些额外提示。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> port = chrome.runtime.connect(&#123; <span class="attr">name</span>: <span class="string">"channel_123"</span> &#125;);</span><br><span class="line">port.postMessage(&#123;<span class="attr">joke</span>: <span class="string">"Knock knock"</span>&#125;);</span><br><span class="line">port.onMessage.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (msg.question == <span class="string">"Who's there?"</span>)</span><br><span class="line">    port.postMessage(&#123;<span class="attr">answer</span>: <span class="string">"Madame"</span>&#125;);</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (msg.question == <span class="string">"Madame who?"</span>)</span><br><span class="line">    port.postMessage(&#123;<span class="attr">answer</span>: <span class="string">"Madame... Bovary"</span>&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>接收端需要注册onConnect来监听channel建立过程：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">chrome.runtime.onConnect.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">port</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 这里可以通过name判断需要监听的channel</span></span><br><span class="line">  <span class="built_in">console</span>.assert(port.name == <span class="string">"channel_123"</span>);</span><br><span class="line">  port.onMessage.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.joke == <span class="string">"Knock knock"</span>)</span><br><span class="line">      port.postMessage(&#123;<span class="attr">question</span>: <span class="string">"Who's there?"</span>&#125;);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (msg.answer == <span class="string">"Madame"</span>)</span><br><span class="line">      port.postMessage(&#123;<span class="attr">question</span>: <span class="string">"Madame who?"</span>&#125;);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (msg.answer == <span class="string">"Madame... Bovary"</span>)</span><br><span class="line">      port.postMessage(&#123;<span class="attr">question</span>: <span class="string">"I don't get it."</span>&#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="跨扩展消息（Cross-extension-messaging）"><a href="#跨扩展消息（Cross-extension-messaging）" class="headerlink" title="跨扩展消息（Cross-extension messaging）"></a>跨扩展消息（Cross-extension messaging）</h3><p>单次消息和长连接消息也有用法几乎相同的跨扩展API：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// For simple requests:</span></span><br><span class="line">chrome.runtime.onMessageExternal.addListener(</span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params">request, sender, sendResponse</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sender.id == blocklistedExtension)</span><br><span class="line">      <span class="keyword">return</span>;  <span class="comment">// don't allow this extension access</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (request.getTargetData)</span><br><span class="line">      sendResponse(&#123;<span class="attr">targetData</span>: targetData&#125;);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (request.activateLasers) &#123;</span><br><span class="line">      <span class="keyword">var</span> success = activateLasers();</span><br><span class="line">      sendResponse(&#123;<span class="attr">activateLasers</span>: success&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// For long-lived connections:</span></span><br><span class="line">chrome.runtime.onConnectExternal.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">port</span>) </span>&#123;</span><br><span class="line">  port.onMessage.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// See other examples for sample onMessage handlers.</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The ID of the extension we want to talk to.</span></span><br><span class="line"><span class="keyword">var</span> laserExtensionId = <span class="string">"abcdefghijklmnoabcdefhijklmnoabc"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Make a simple request:</span></span><br><span class="line">chrome.runtime.sendMessage(laserExtensionId, &#123;<span class="attr">getTargetData</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (targetInRange(response.targetData))</span><br><span class="line">      chrome.runtime.sendMessage(laserExtensionId, &#123;<span class="attr">activateLasers</span>: <span class="literal">true</span>&#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Start a long-running conversation:</span></span><br><span class="line"><span class="keyword">var</span> port = chrome.runtime.connect(laserExtensionId);</span><br><span class="line">port.postMessage(...);</span><br></pre></td></tr></table></figure>
<h2 id="扩展的数据存储"><a href="#扩展的数据存储" class="headerlink" title="扩展的数据存储"></a>扩展的数据存储</h2><p>在扩展中<code>HTML5 Storage API</code>同样是可用的，这里主要介绍chrome提供用于存储扩展设置的API<code>chrome.storage</code>:<br>相较于通过接口或者其他方式实现的存储，<code>chrome.storage</code>优势主要有：</p>
<ul>
<li>存储于其中的数据能跟随用户当前登陆的google账号同步到云端（通过<code>storage.sync</code>）</li>
<li>多种脚本都能直接访问不需要借助后台脚本</li>
<li>能直接存储js对象，性能更高（<code>HTML5 Storage API</code>则需要序列化）</li>
</ul>
<p>使用前需要在Manifest中申请权限：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"permissions"</span>: [<span class="string">"storage"</span>],</span><br></pre></td></tr></table></figure></p>
<p>读取和写入都非常简单：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">chrome.storage.sync.set(&#123;<span class="attr">key</span>: value&#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Value is set to '</span> + value);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">chrome.storage.sync.get([<span class="string">'key'</span>], <span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Value currently is '</span> + result.key);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>如果你不想同步到用户账户里只想做本机的存储可以使用<code>storage.local</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">chrome.storage.local.set(&#123;<span class="attr">key</span>: value&#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Value is set to '</span> + value);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">chrome.storage.local.get([<span class="string">'key'</span>], <span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Value currently is '</span> + result.key);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="网络请求劫持"><a href="#网络请求劫持" class="headerlink" title="网络请求劫持"></a>网络请求劫持</h2><p>通过<code>webRequest API</code>可以实现任意页面任意请求的拦截和修改，该API的全生命周期如下：<br><img src="https://i.loli.net/2020/07/03/l8UvIGgJYLfROui.png" alt></p>
<p>一个简单的拦截请求Demo：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chrome.webRequest.onBeforeRequest.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">details</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> &#123;<span class="attr">cancel</span>: details.url.indexOf(<span class="string">"://www.block.com/"</span>) != <span class="number">-1</span>&#125;;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;<span class="attr">urls</span>: [<span class="string">"&lt;all_urls&gt;"</span>]&#125;,</span><br><span class="line">[<span class="string">"blocking"</span>]);</span><br></pre></td></tr></table></figure></p>
<p>所有url中包含<a href="http://www.block.com域名的请求都会被直接拦截。" target="_blank" rel="noopener">www.block.com域名的请求都会被直接拦截。</a></p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>这里用工作中遇到的一个真实案例来演示：</p>
<h3 id="问题来源"><a href="#问题来源" class="headerlink" title="问题来源"></a>问题来源</h3><p>一些项目的鉴权方式依赖登录站点的set-cookie，导致开发模式下（localhost）无法访问live环境接口，调试极为不便。</p>
<h3 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h3><p>想到可以“拷贝”登录所需的cookie到localhost下通过鉴权，所以实现监听set-cookie的写入操作并同步写入到localhost即可。</p>
<h3 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h3><p>可以想到需要的部件</p>
<ul>
<li>设置弹窗：设置监听哪些域下的cookie</li>
<li>后台脚本：监听cookie变化并写入到指定域名</li>
<li>通知弹窗：通知用户当前监听的域名</li>
</ul>
<h4 id="manifest-json"><a href="#manifest-json" class="headerlink" title="manifest.json"></a>manifest.json</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"Auto Sync Cookie"</span>,</span><br><span class="line">  <span class="string">"description"</span>: <span class="string">"listen and sync Cookie to target domain."</span>,</span><br><span class="line">  <span class="string">"version"</span>: <span class="string">"0.1"</span>,</span><br><span class="line">  <span class="string">"manifest_version"</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="string">"permissions"</span>: [<span class="string">"storage"</span>, <span class="string">"cookies"</span>, <span class="string">"&lt;all_urls&gt;"</span>, <span class="string">"notifications"</span>],</span><br><span class="line">  <span class="comment">// 申请所需的权限：存储，cookie，通知</span></span><br><span class="line">  <span class="string">"icons"</span>: &#123; <span class="string">"16"</span>: <span class="string">"icon.png"</span>, <span class="string">"48"</span>: <span class="string">"icon.png"</span>, <span class="string">"128"</span>: <span class="string">"icon.png"</span> &#125;,</span><br><span class="line">  <span class="comment">// 定义了一个弹窗popup.html</span></span><br><span class="line">  <span class="string">"browser_action"</span>: &#123;</span><br><span class="line">      <span class="string">"default_title"</span>: <span class="string">"Listen &amp; Sync Cookie to target domain."</span>,</span><br><span class="line">      <span class="string">"default_icon"</span>: <span class="string">"icon.png"</span>,</span><br><span class="line">      <span class="string">"default_popup"</span>: <span class="string">"popup.html"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 定义了一个后台脚本background.js</span></span><br><span class="line">  <span class="string">"background"</span>: &#123;</span><br><span class="line">    <span class="string">"scripts"</span>: [<span class="string">"background.js"</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="background-js"><a href="#background-js" class="headerlink" title="background.js"></a>background.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 存储设置</span></span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">    listenDomain: [],</span><br><span class="line">    syncURL: <span class="string">''</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从chrome.storage获取初值（似乎要发布到商店上才能看到云同步效果）</span></span><br><span class="line">chrome.storage.sync.get([<span class="string">'listenDomain'</span>, <span class="string">'syncURL'</span>], (&#123; listenDomain = [], syncURL = <span class="string">''</span> &#125;) =&gt; &#123;</span><br><span class="line">    config.listenDomain = listenDomain</span><br><span class="line">    config.syncURL = syncURL</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从弹窗更新了设置后同步最新设置项</span></span><br><span class="line">chrome.storage.onChanged.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">&#123; listenDomain, syncURL &#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (listenDomain) &#123;</span><br><span class="line">        config.listenDomain = listenDomain.newValue</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (syncURL) &#123;</span><br><span class="line">        config.syncURL = syncURL.newValue</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发出通知</span></span><br><span class="line">    chrome.notifications.create(<span class="literal">null</span>, &#123;</span><br><span class="line">        type: <span class="string">'basic'</span>,</span><br><span class="line">        iconUrl: <span class="string">'icon.png'</span>,</span><br><span class="line">        title: <span class="string">'Setting Successfully'</span>,</span><br><span class="line">        message: <span class="string">`Now Listening: <span class="subst">$&#123;config.listenDomain.join(<span class="string">', '</span>)&#125;</span>`</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听cookie变化并写入syncURL</span></span><br><span class="line">chrome.cookies.onChanged.addListener(<span class="function"><span class="keyword">function</span>(<span class="params">info</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;cause, <span class="attr">cookie</span>: &#123;domain, name, path, value&#125;, removed&#125; = info</span><br><span class="line">    <span class="keyword">if</span>(config.listenDomain.includes(domain) &amp;&amp; removed === <span class="literal">false</span> &amp;&amp; cause === <span class="string">'explicit'</span>) &#123;</span><br><span class="line">        chrome.cookies.set(&#123;</span><br><span class="line">            url: config.syncURL,</span><br><span class="line">            name,</span><br><span class="line">            value,</span><br><span class="line">            path,</span><br><span class="line">        &#125;, msg =&gt; <span class="built_in">console</span>.log(<span class="string">'sync success:'</span>, msg))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="popup-html"><a href="#popup-html" class="headerlink" title="popup.html"></a>popup.html</h4><figure class="highlight htmlbars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Setting<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">style</span>&gt;</span></span></span><br><span class="line"><span class="xml">  /** 样式 **/</span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"setting-box"</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="xml">    Listen Domains</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">"listen-domain"</span> <span class="attr">placeholder</span>=<span class="string">"domain.com (support multi-line)"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="xml">    Sync URL</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"sync-url"</span> <span class="attr">placeholder</span>=<span class="string">"http://localhost"</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"save-btn"</span>&gt;</span>Sync<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">/** 弹窗的内容页脚本引入 **/</span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"popup.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h4 id="popup-js"><a href="#popup-js" class="headerlink" title="popup.js"></a>popup.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 页面dom加载完后再执行</span></span><br><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'DOMContentLoaded'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ls = <span class="built_in">document</span>.querySelector(<span class="string">'#listen-domain'</span>)</span><br><span class="line">  <span class="keyword">const</span> sy = <span class="built_in">document</span>.querySelector(<span class="string">'#sync-url'</span>)</span><br><span class="line">  <span class="keyword">const</span> syncBtn = <span class="built_in">document</span>.querySelector(<span class="string">'#save-btn'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 回填保存的设置值</span></span><br><span class="line">  chrome.storage.sync.get(</span><br><span class="line">      [<span class="string">'listenDomain'</span>, <span class="string">'syncURL'</span>],</span><br><span class="line">      (&#123; listenDomain = [], syncURL = <span class="string">''</span> &#125;) =&gt; &#123;</span><br><span class="line">        ls.value = listenDomain.join(<span class="string">'\n'</span>)</span><br><span class="line">        sy.value = syncURL</span><br><span class="line">      &#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 保存新的设置值</span></span><br><span class="line">  syncBtn.onclick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> listenDomain = ls.value.trim().split(<span class="regexp">/\n/</span>)</span><br><span class="line">    <span class="keyword">const</span> syncURL = sy.value.trim()</span><br><span class="line">    <span class="keyword">if</span> (listenDomain &amp;&amp; syncURL) &#123;</span><br><span class="line">      chrome.storage.sync.set(&#123; listenDomain, syncURL &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://s0urcelab.github.io/2020/06/02/js-chrome-extensions-101/" data-id="cklscs99d000wxmovnc57l9ap" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FrontEnd/">FrontEnd</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2019/06/21/js-review-es6/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">重读ES6</div>
    </a>
  
</nav>

  
</article>


  <section id="comments">
    <!-- gitalk评论框 start -->
    <div id="gitalk-container"></div>
    <script type="text/javascript">
      const gitalk = new Gitalk({
        clientID: 'ddd3bf586cb3ad3a9ea9',
        clientSecret: '53df04f0f4f625cf880f3d4d03a33754af977566',
        repo: 's0urcelab.github.io',
        owner: 's0urcelab',
        admin: ['s0urcelab'],
        id: location.pathname,      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      });
      gitalk.render('gitalk-container');
    </script>
    <!-- gitalk评论框 end -->
  </section>
  
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/FrontEnd/">FrontEnd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WOT/">WOT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/test/">test</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tutorial/">tutorial</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/FrontEnd/" style="font-size: 20px;">FrontEnd</a> <a href="/tags/WOT/" style="font-size: 10px;">WOT</a> <a href="/tags/test/" style="font-size: 15px;">test</a> <a href="/tags/tutorial/" style="font-size: 10px;">tutorial</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/06/02/js-chrome-extensions-101/">Chrome扩展开发101</a>
          </li>
        
          <li>
            <a href="/2019/06/21/js-review-es6/">重读ES6</a>
          </li>
        
          <li>
            <a href="/2019/04/16/smart-git-guide/">smartGit使用指南</a>
          </li>
        
          <li>
            <a href="/2019/04/12/js-concurrent-test/">并发请求小练习</a>
          </li>
        
          <li>
            <a href="/2019/02/18/js-design-pattern/">JS中的常见设计模式及应用场景</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 s0urce<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/ppt" class="mobile-nav-link">PPT</a>
  
</nav>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/anime.min.js"></script>
<script src="/js/script.js"></script>

  </div>
</body>
</html>